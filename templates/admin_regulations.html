<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>admin_regulations</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script> <!-- 引入 Axios -->
    <link rel="stylesheet" href="/static/css/admin_regulations.css">

</head>


<body>
    {% raw %}
    <!-- Header -->
    <div class="content-container">
        <header>
            <nav>
                <ul>
                    <li><a href="/admin/notifi">會議通知</a></li>
                    <li><a href="/admin/minutes">會議記錄</a></li>
                    <li><a href="/admin/regulations">規章</a></li>
                    <li><a href="/logout">登出</a></li>
                </ul>
            </nav>
        </header>
        <div id="app">
            <button class="new_btn" @click="openModal(-1)">新增規章內容</button>
            <div v-if="loading" class="loading-overlay">
                <div class="loading-box">
                    <div class="spinner-border custom-spinner" role="status"></div>
                    <span class="loading-text">載入中...</span>
                </div>
            </div>
            <div v-for="(items, key) in categories" :key="key" class="section">
                <h1>{{ key }}</h1>
                <div v-for="item in items" :key="item.id">
                    <button class="item_btn" @click="openModal(item.id)">{{ item.title }}</button>
                </div>
            </div>
            <!-- Modal -->
            <div class="modal fade" id="itemModal" tabindex="-1" aria-labelledby="itemModalLabel" aria-hidden="true"
                data-bs-backdrop="static">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title w-100" id="itemModalLabel">
                                <div class="form-group">
                                    <label for="title" class="input_text">規章標題 :</label>
                                    <input id="title" type="text" class="form-control" placeholder="例：國立臺灣大學學生權利大憲章"
                                        aria-label="會議標題" aria-describedby="basic-addon1" v-model="modalTitle">
                                </div>
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="category" class="input_text">分類 :</label>
                                <input id="category" type="text" class="form-control" placeholder="例：憲制性法規篇"
                                    aria-label="分類" aria-describedby="basic-addon1" v-model="modalCategory">
                            </div>
                            <div class="input_text">修訂版本 :</div>
                            <div class="revisions-wrapper">
                                <div v-for="(record, Index) in revisionRecords" :key="Index"
                                    class="row revision-wrapper">
                                    <div class="col-12 col-md-5">
                                        <div class="d-flex align-items-center justify-content-start field-group">
                                            <label class="form-label revision-label mb-1 mb-md-0">日期 :</label>
                                            <input type="date" class="form-control date-input" v-model="record.date"
                                                :ref="`revisionDate-${Index}`">
                                        </div>
                                    </div>
                                    <div class="col-12 col-md-7">
                                        <div class="d-flex align-items-center justify-content-start field-group">
                                            <label class="form-label revision-label mb-1 mb-md-0">說明 :</label>
                                            <input type="text" class="form-control note-input" v-model="record.note"
                                                :ref="`revisionNote-${Index}`" placeholder="學生代表大會增訂公布第九條第一項第八款條文" />
                                        </div>
                                    </div>
                                </div>
                                <div class="agenda-item">
                                    <button class="btn revision_btn" @click="addRevision()">新增版本</button>
                                    <div v-if="revisionRecords.length > 0">
                                        <button class="btn delete_btn" @click="deleteRevision()">
                                            刪除版本
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="description" class="input_text">規章說明 :</label>
                                <textarea id="description" class="form-control auto-resize-textarea"
                                    @input="autoResize($event)" placeholder="我們相信,民主是普世共通的價值,在學術場域中亦須有所體現。大學在憲法與法.."
                                    aria-label="規章說明" aria-describedby="basic-addon1"
                                    v-model="modalDescription"></textarea>
                            </div>

                            <div class="input_text">內容</div>
                            <!-- 最後一條是:{{articleLastNumber}} -->
                            <div v-for="(chapter, index) in modalChapters" :key="index" class="mb-4">
                                <!-- 章標題 -->
                                <div class="agenda-item">
                                    <div class="input_text">第{{ chapter.chineseNumbers }}章 </div>
                                    <div class="input-group">
                                        <input id="chapter_title" type="text" class="form-control" placeholder="此章節標題"
                                            aria-label="章節標題" aria-describedby="basic-addon1" v-model="chapter.title"
                                            :ref="`chapterTitle-${index}`" />
                                        <div class="input-group-append d-flex">
                                            <button class="btn detail_btn" @click="addArticle(index,-1)">＋條</button>
                                            <button v-if="index && index === modalChapters.length-1"
                                                class="btn delete_btn" @click="deleteChapter(index)">－章
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <!-- 條列表 -->
                                <div v-for="(article, aIndex) in chapter.articles" :key="aIndex" class="ms-3 mt-1">
                                    <div class="agenda-item">
                                        <div class="article_text">第{{ article.converted }}</div>
                                        <!-- {{article.sort_index}}</div> -->
                                        <div class="input-group">
                                            <input id="article_title" type="text" class="form-control"
                                                placeholder="此條標題" aria-label="條標題" v-model="article.title"
                                                :ref="`articleTitle-${index}-${aIndex}`" />
                                            <!-- 放在右邊 -->
                                            <div class="input-group-append d-flex">
                                                <button class="btn detail_btn" @click="addParagraph(article, -1)">
                                                    ＋項
                                                </button>
                                                <button class="btn detail_btn" @click="addArticle(index, aIndex)">
                                                    ＋條
                                                </button>
                                                <!-- userid === -1 -->
                                                <button v-if=" 1" class="btn delete_btn"
                                                    @click="deleteArticle(index, aIndex)">
                                                    －條
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 項列表 -->
                                    <div v-for="(paragraph,pIndex) in article.paragraphs" :key="pIndex"
                                        class="ms-5 mt-1">
                                        <div class="agenda-item">
                                            <span class="normal_text">{{ paragraph.number }}、</span>
                                            <div class="textarea-wrapper" :class="{'three-buttons': 1}">
                                                <textarea class="form-control mb-2 auto-resize-textarea"
                                                    v-model="paragraph.content"
                                                    :ref="`paragraphTextarea-${index}-${aIndex}-${pIndex}`"
                                                    @input="autoResize($event)" placeholder="此項內容"></textarea>
                                                <div class="textarea-buttons">
                                                    <button class="btn detail_btn mb-1"
                                                        @click="addClause(paragraph,-1)">＋款</button>
                                                    <button class="btn detail_btn mb-1"
                                                        @click="addParagraph(article,pIndex)">＋項</button>
                                                    <button class="btn delete_btn"
                                                        @click="deleteParagraph(article.paragraphs,pIndex)">－項</button>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- 款列表 -->
                                        <div v-for="(clause,cIndex) in paragraph.clauses" :key="cIndex"
                                            class="ms-5 mt-1">
                                            <div class="agenda-item">
                                                <span class="input_text">{{ clause.chineseNumber }}、</span>
                                                <div class="textarea-wrapper">
                                                    <textarea class="form-control mb-2 auto-resize-textarea"
                                                        v-model="clause.content"
                                                        :ref="`clauseTextarea-${index}-${aIndex}-${pIndex}-${cIndex}`"
                                                        @input="autoResize($event)" placeholder="此款內容"></textarea>

                                                    <div class="textarea-buttons">
                                                        <button class="btn detail_btn mb-1"
                                                            @click="addClause(paragraph, cIndex)">＋款</button>
                                                        <button class="btn delete_btn"
                                                            @click="deleteClause(paragraph.clauses, cIndex)">－款</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div v-if="index === modalChapters.length-1">
                                    <div class="agenda-item">
                                        <button type="button" class="chapter_btn" @click="addChapters()">新增章節</button>
                                    </div>
                                    <br>
                                </div>
                            </div>


                            <div class="agenda-item mb-3 d-flex align-items-center">
                                <label class="input_text mb-0 me-2" style="min-width: auto;">是否上架：</label>
                                <label class="switch">
                                    <input type="checkbox" v-model="is_visible" />
                                    <span class="slider"></span>
                                </label>
                                <span class="ms-2">{{ is_visible ? '上架' : '不上架' }}</span>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary"
                                    @click="saveChange(userid)">儲存規章(還沒用好，先不要按)</button>
                                <div v-if="uploading" class="uploading-overlay">
                                    <div class="uploading-box">
                                        <div class="spinner-border custom-spinner" role="status"></div>
                                        <span class="uploading-text">上傳中，請稍候...
                                            請不要離開此頁面</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Footer -->
            <footer>
                <p>&copy; 2025 Your Company. All rights reserved.</p>
            </footer>
        </div>
        <script>
            new Vue({
                el: '#app',
                data: {
                    uploading: false,
                    loading: false,
                    chineseNumbers: ["一", "二", "三", "四", "五", "六", "七", "八", "九", "十", "十一", "十二", "十三", "十四", "十五", "十六", "十七", "十八", "十九", "二十", "二十一", "二十二", "二十三", "二十四", "二十五", "二十六", "二十七"],
                    restrictedTitles: [
                        "宣布開會", "確認議程", "主席報告", "報告事項", "討論事項", "臨時動議", "自由發言", "散會"
                    ],
                    latest_category: "",
                    categories: {},
                    category_list: [],
                    modalTitle: '',  // 绑定到 input 的值
                    modalCategory: '',
                    modalDescription: '',
                    modalPerson: '',
                    modalShorthand: '',
                    revisionRecords: [],
                    modalPresent: '',
                    modalAttendance: '',
                    modalChapters: [],// 原始資料
                    articleLastNumber: 0,
                    chapterLastNumber: 0,
                    modalAddChapter: [],
                    userid: 0,
                    is_visible: true,
                    hasEmptyContent: false
                },
                async created() {
                    await this.fetchBackendData();
                },
                computed: {
                },
                methods: {
                    async fetchBackendData() {// 获取后端数据的方法
                        try {
                            const response = await axios.get('/admin/regulations/data');
                            if (response.data) {
                                this.category_list = response.data.category_list;
                                const tmp = response.data.regulations;
                                for (let i = 0; i < tmp.length; i++) {
                                    if (!(tmp[i]["category"] in this.categories)) {
                                        this.$set(this.categories, tmp[i]["category"], []);
                                    }
                                    this.categories[tmp[i]["category"]].push(tmp[i]);
                                }
                                this.latest_category = this.category_list[0];
                            }
                        } catch (error) {
                            alert(`無法正確取得規章資料，請截圖並和工程師聯繫。\n錯誤訊息為 : ${error}`);
                        }
                    },
                    closeModal() {
                        var myModal = bootstrap.Modal.getInstance(document.getElementById('itemModal'));
                        myModal.hide();
                    },
                    parseString(str) {
                        const result = [];
                        if (!str || str.trim() === "") throw new Error("輸入不能為空白");

                        if (/^\S+$/.test(str.trim())) {
                            const items = str.trim().split("、")
                            return [{ role: items[0], members: [] }];
                        }

                        const items = str.split("、")
                            .map(item => item.trim())
                            .filter(item => item !== "");

                        items.forEach(item => {
                            item = item.replace(/\s+/g, " ");
                            const parts = item.split(" ");

                            if (parts.length < 2) {
                                result.push({ role: parts[0], members: [] });
                                return;
                            }

                            const role = parts[0];
                            const name = parts.slice(1).join(" ");

                            let existing = result.find(entry => entry.role === role);
                            if (existing) {
                                existing.members.push(name);
                            } else {
                                result.push({ role, members: [name] });
                            }
                            // 議長 xxx、議長 123、as議長 xxx、as議、as議、as議長 232、as議長 323、as議長xxx
                        });
                        return result;
                    },
                    async openModal(itemID) {
                        const modalEl = document.getElementById("itemModal");
                        this.userid = itemID
                        console.log('userid', this.userid)
                        this.modalAddChapter = [];
                        this.modalTitle = ""
                        this.modalCategory = this.latest_category
                        this.modalDescription = ""
                        this.revisionRecords = []
                        this.is_visible = true
                        this.articleLastNumber = 0
                        this.chapterLastNumber = 0

                        this.modalChapters = [
                            { number: 1, chineseNumbers: '一', title: "", articles: [] },
                        ]

                        if (!(itemID === -1)) {
                            await this.getdetail(itemID);
                        }
                        this.loading = false;
                        // 資料準備好再開啟 modal
                        modalEl.addEventListener('shown.bs.modal', () => {
                            this.autoResizeAll();
                        });
                        const modal = new bootstrap.Modal(modalEl);
                        modal.show();
                    },
                    async getdetail(itemID) {
                        this.loading = true;
                        this.modalCategory = ""
                        this.modalChapters = []
                        try {
                            const response = await axios.get(`/admin/regulations/data/${itemID}`);
                            if (response.data) {
                                const tmp = response.data.regulations;
                                console.log(tmp)
                                this.modalTitle = tmp.title
                                this.modalCategory = tmp.category
                                this.modalDescription = tmp.description
                                this.is_visible = tmp.is_visible
                                //版本
                                let revisions = tmp.revisions
                                for (let vision in revisions) {
                                    this.revisionRecords.push({
                                        date: this.formatDate(new Date(revisions[vision].modified_at)),
                                        note: revisions[vision].note
                                    })
                                }
                                //版本

                                let chapters = tmp.chapters
                                if (chapters.length === 0) {
                                    this.modalChapters = [
                                        { number: 1, chineseNumbers: '一', title: "", articles: [] },
                                    ]
                                    return;
                                }
                                chapters.sort((a, b) => a.number - b.number);
                                this.chapterLastNumber = chapters.length - 1
                                for (let idx in chapters) {
                                    console.log(chapters[idx].title)
                                    let articles = chapters[idx].articles
                                    let article = []
                                    articles.sort((a, b) => a.sort_index - b.sort_index);
                                    let sort_index = []
                                    for (let aIndex in articles) {
                                        sort_index.push(articles[aIndex].sort_index)
                                    }

                                    let convertedList = this.convertArticles(sort_index, 0)
                                    for (let aIndex in articles) {
                                        let paragraphs = articles[aIndex].paragraphs
                                        let paragraph = []
                                        paragraphs.sort((a, b) => a.number - b.number);
                                        for (let pIndex in paragraphs) {
                                            // console.log(paragraphs[pIndex].content)
                                            let clauses = paragraphs[pIndex].clauses
                                            let clause = []
                                            clauses.sort((a, b) => a.number - b.number);
                                            for (let cIndex in clauses) {
                                                // console.log(clauses[cIndex].content)
                                                clause.push({
                                                    id: clauses[cIndex].id,
                                                    number: clauses[cIndex].number,
                                                    chineseNumber: this.chineseNumbers[clause.length],
                                                    content: clauses[cIndex].content,
                                                }
                                                )
                                            }
                                            paragraph.push({
                                                id: paragraphs[pIndex].id,
                                                number: paragraphs[pIndex].number,
                                                content: paragraphs[pIndex].content,
                                                clauses: clause,
                                            }
                                            )
                                        }

                                        article.push({
                                            id: articles[aIndex].id,
                                            title: articles[aIndex].title,
                                            sort_index: articles[aIndex].sort_index,
                                            converted: convertedList[aIndex].converted,
                                            paragraphs: paragraph,
                                        }
                                        )
                                    }
                                    this.modalChapters.push({
                                        chineseNumbers: this.chineseNumbers[this.modalChapters.length],  // 使用長度來直接獲取對應的數字
                                        number: chapters[idx].number,
                                        title: chapters[idx].title,
                                        articles: article
                                    });
                                }
                            }
                        } catch (error) {
                            alert(`無法取得此筆規章資料，請截圖並和工程師聯繫。\n錯誤訊息為 : ${error}`);
                        } finally {
                            this.loading = false;
                        }
                    },
                    async saveChange(id) {
                        console.log('儲存ID = ', id, '的規章')
                        const title = document.getElementById("title").value.trim();
                        const category = document.getElementById("category").value.trim();
                        const description = document.getElementById("description").value.trim();
                        const is_visible = this.is_visible
                        // ✅ 基本欄位驗證
                        if (!title || !category) {
                            alert("請填寫所有必填欄位（標題、分類）");
                            return;
                        }
                        const formData = new FormData();
                        formData.append("id", id);
                        formData.append("is_visible", is_visible);
                        formData.append("title", title);
                        formData.append("category", category);
                        formData.append("description", description);

                        const StructuredContents = this.getStructuredContentFromRefs();
                        const revisionList = StructuredContents[0]
                        const StructuredContent = StructuredContents[1]
                        console.log(revisionList, StructuredContent)
                        if (!this.hasEmptyContent) {// content 要轉成 JSON 字串送到後端
                            formData.append("revision", JSON.stringify(revisionList));
                            formData.append("content", JSON.stringify(StructuredContent));
                            this.uploading = true;
                            try {
                                const response = await axios.post("/admin/regulations/upload", formData, {
                                    headers: {
                                        "Content-Type": "multipart/form-data"
                                    }
                                });
                                if (response.data) {
                                    this.category_list = response.data.category_list;
                                    const tmp = response.data.regulations;
                                    for (let i = 0; i < tmp.length; i++) {
                                        if (!(tmp[i]["category"] in this.categories)) {
                                            this.$set(this.categories, tmp[i]["category"], []);
                                        }
                                        this.categories[tmp[i]["category"]].push(tmp[i]);
                                    }
                                    this.latest_category = this.category_list[0];
                                }
                                this.closeModal();
                                this.uploading = false;
                                window.location.reload();
                            } catch (error) {
                                alert(`規章上傳/修改失敗，請截圖並和工程師聯繫。\n錯誤訊息為 : ${error}`);
                                this.uploading = false;
                            }
                        }
                        this.hasEmptyContent = false
                    },
                    addRevision() {
                        this.revisionRecords.push({
                            date: ``,
                            note: ``
                        })
                    },
                    deleteRevision() {
                        this.revisionRecords.splice(-1, 1);
                    },
                    addChapters() {
                        this.modalChapters.push({
                            number: this.modalChapters.length + 1,
                            chineseNumbers: this.chineseNumbers[this.modalChapters.length],  // 使用長度來直接獲取對應的數字
                            title: "",
                            articles: []
                        })
                        this.chapterLastNumber = this.modalChapters.length - 1
                    },
                    deleteChapter(chapterIndex) {
                        let articles = this.modalChapters[chapterIndex - 1].articles
                        if (articles.length) this.articleLastNumber = Math.floor(articles[articles.length - 1].sort_index)

                        this.modalChapters.splice(chapterIndex, 1);
                    },
                    addArticle(index, aIndex) {
                        console.log(index, aIndex)
                        if (index > 0) {
                            if (this.modalChapters[index - 1].articles.length === 0) {
                                alert(`第${this.modalChapters[index - 1].number}章沒有條，因此無法新增此條`)
                                return
                            }
                        }
                        let articles = this.modalChapters[index].articles;

                        if (aIndex === -1 || articles.length === 0) {//該章沒條 or 該章有條，新增在最前面
                            this.articleLastNumber += 1
                            for (let chapterIdx = index; chapterIdx < this.modalChapters.length; chapterIdx++) {
                                this.updateArticlesAfterAdd(chapterIdx, 0); // 全部章的條+1
                            }
                            let newSortIndex = articles.length === 0 ? this.articleLastNumber : articles[0].sort_index - 1;
                            let newConverted = `${this.numberToChinese(newSortIndex)}條`;
                            articles.splice(aIndex + 1, 0, this.createArticle(newSortIndex, newConverted, 1));
                            return
                        }
                        // 新增在條和條之間 新條 or 之一條
                        let newSortIndex = 0;
                        let newConverted = '';
                        const currentArticle = articles[aIndex];
                        const currentSortIndex = currentArticle.sort_index;

                        if (index === this.chapterLastNumber) {//最後一個章
                            if (articles.length === aIndex + 1) {// 最後一章且最後一條 =>直接+1
                                newSortIndex = (Math.floor(currentSortIndex) + 1)
                                this.articleLastNumber = newSortIndex
                                newConverted = `${this.numberToChinese(newSortIndex)}條`;
                                articles.push(this.createArticle(newSortIndex, newConverted, 1));
                                return
                            }
                            else { newSortIndex = (currentSortIndex + articles[aIndex + 1].sort_index) / 2 }// 最後章 不是最後一條
                        }
                        else {
                            if (articles.length === aIndex + 1) {
                                newSortIndex = (Math.floor(currentSortIndex) + 1)
                                if (this.articleLastNumber >= newSortIndex) { newSortIndex = (currentSortIndex + Math.floor(currentSortIndex) + 1) / 2 }// 不是最後一章 該章最後一條 但lastArticle != 該章最後一條
                                else {// 不是最後一章 最後一條 lastArticle == 該章最後一條
                                    this.articleLastNumber = newSortIndex
                                    newConverted = `${this.numberToChinese(newSortIndex)}條`;
                                    articles.push(this.createArticle(newSortIndex, newConverted, 1));
                                    return
                                }
                            }
                            else { newSortIndex = (currentSortIndex + articles[aIndex + 1].sort_index) / 2 }// 不是最後一章 不是最後一條
                        }
                        articles.push(this.createArticle(newSortIndex, newConverted));
                        articles.sort((a, b) => a.sort_index - b.sort_index);

                        let newSortIndices = articles.map(article => article.sort_index);
                        if (newSortIndices.length) {
                            const convertedList = this.convertArticles(newSortIndices, 1);
                            articles.forEach((article, i) => article.converted = convertedList[i].converted);
                        }
                    },
                    deleteArticle(index, aIndex) {//只有新增檔案可以刪除條
                        let articles = this.modalChapters[index].articles;
                        if (articles.length === 1) {
                            for (let idx = index + 1; idx < this.modalChapters.length; idx += 1)
                                if (this.modalChapters[idx].articles.length != 0) {
                                    alert(`後面章節還有其他條，因此無法刪除`)
                                    return
                                }
                        }
                        let currentArticle = articles[aIndex];
                        if (this.articleLastNumber == currentArticle.sort_index && this.articleLastNumber != 0) this.articleLastNumber -= 1
                        const isIntegerArticle = Number.isInteger(currentArticle.sort_index);

                        if (isIntegerArticle) {//整數條，代表後面 整數條要改
                            console.log('刪除整數條');
                            if (aIndex + 1 == articles.length) { //該章節最後一條 only 3, 另一章節(4, 4-1), 刪除3
                                for (let chapterIdx = index + 1; chapterIdx < this.modalChapters.length; chapterIdx++) {
                                    this.updateArticlesAfterDelete(chapterIdx, 0);
                                }
                            }
                            else if (Math.floor(articles[aIndex + 1].sort_index) === currentArticle.sort_index) {
                                // 非該章節最後
                                // 後面有條和要刪除的同整數位置 2,2-1,2-2,2-3,3,3-1,4 刪除2
                                let startIdx = aIndex + 1
                                const newSortIndices = [];

                                for (let i = articles.length - 1; i > aIndex; i--) {
                                    if (Math.floor(articles[i].sort_index) == currentArticle.sort_index) {
                                        //後面的條和要刪除的同整數位置
                                        articles[i].sort_index = articles[i - 1].sort_index;
                                        newSortIndices.push(articles[i].sort_index);
                                    }
                                }
                                newSortIndices.sort((a, b) => a - b);
                                if (newSortIndices.length) {
                                    const convertedList = this.convertArticles(newSortIndices, 1);
                                    for (let i = startIdx; i < articles.length; i++) {
                                        if (Math.floor(articles[i].sort_index) == articles[aIndex].sort_index) {
                                            articles[i].converted = convertedList[i - startIdx].converted;
                                        }
                                    }
                                }
                            }
                            else { // 後面沒有條和要刪除的同整數位置 2,3,3-1,4 刪除2
                                this.updateArticlesAfterDelete(index, aIndex);
                                for (let chapterIdx = index + 1; chapterIdx < this.modalChapters.length; chapterIdx++) {
                                    this.updateArticlesAfterDelete(chapterIdx, 0);
                                }
                            }
                        }
                        else { //非整數條，代表後面其他整數條不用改
                            console.log('刪除非整數條');
                            if (aIndex > 0) {
                                for (let i = articles.length - 1; i > aIndex; i--) {
                                    if (Math.floor(articles[i].sort_index) == Math.floor(currentArticle.sort_index)) {
                                        articles[i].converted = articles[i - 1].converted
                                        articles[i].sort_index = articles[i - 1].sort_index
                                    }
                                }
                            }
                        }
                        articles.splice(aIndex, 1);
                    },
                    addParagraph(articles, pIndex) {
                        let paragraphs = articles.paragraphs
                        if (pIndex === -1 || paragraphs.length === 0) {
                            paragraphs.splice(0, 0, {
                                number: 1,
                                content: '',
                                clauses: [],
                            });
                            console.log('目前沒有項')
                        }
                        else {// 插入一款在 cIndex + 1 位置，並調整後方所有款編號
                            const newNumber = paragraphs[pIndex].number + 1;
                            paragraphs.splice(pIndex + 1, 0, {
                                number: newNumber,
                                content: '',
                                clauses: [],
                            });
                            console.log('已經有其他項')
                        }

                        // 重新編號所有後續款
                        for (let i = pIndex + 2; i < paragraphs.length; i++) {
                            paragraphs[i].number = paragraphs[i - 1].number + 1;
                        }
                    },
                    deleteParagraph(paragraphs, pIndex) {
                        // 重新編號所有後續款
                        for (let i = paragraphs.length - 1; i > pIndex; i--) {
                            paragraphs[i].number = paragraphs[i - 1].number;
                        }
                        paragraphs.splice(pIndex, 1);
                    },
                    addClause(paragraph, cIndex) {
                        const clauses = paragraph.clauses;
                        // 沒有任何款時，直接新增第一款
                        if (cIndex === -1 || clauses.length === 0) {
                            const newNumber = cIndex + 2; //
                            clauses.splice(0, 0, {
                                number: 1,
                                chineseNumber: this.chineseNumbers[0],
                                content: '',
                            });
                        }
                        else {// 插入一款在 cIndex + 1 位置，並調整後方所有款編號
                            const newNumber = clauses[cIndex].number + 1;
                            clauses.splice(cIndex + 1, 0, {
                                number: newNumber,
                                chineseNumber: this.chineseNumbers[newNumber - 1],
                                content: '',
                            });
                        }

                        // 重新編號所有後續款
                        for (let i = cIndex + 2; i < clauses.length; i++) {
                            clauses[i].number = clauses[i - 1].number + 1;
                            clauses[i].chineseNumber = this.chineseNumbers[clauses[i].number - 1];
                        }
                    },
                    deleteClause(clauses, cIndex) {
                        // 重新編號所有後續款
                        for (let i = clauses.length - 1; i > cIndex; i--) {
                            clauses[i].number = clauses[i - 1].number;
                            clauses[i].chineseNumber = this.chineseNumbers[clauses[i].number - 1];
                        }

                        clauses.splice(cIndex, 1);
                    },
                    getStructuredContentFromRefs() {
                        const revisionList = [];
                        this.revisionRecords.forEach((record, Index) => {
                            const dateRrefKey = `revisionDate-${Index}`;
                            const dateEl = this.$refs[dateRrefKey];
                            if (!dateEl) return;  // 沒chapter
                            const dateValue = (Array.isArray(dateEl) ? dateEl[0] : dateEl)?.value || '';
                            if (!dateValue.trim()) {
                                alert(`第 ${Index + 1} 版本時間為空，請填寫或刪除。`);
                                this.hasEmptyContent = true;
                                return;
                            }
                            const noteRrefKey = `revisionNote-${Index}`;
                            const noteEl = this.$refs[noteRrefKey];
                            if (!noteEl) return;  // 沒chapter
                            const noteValue = (Array.isArray(noteEl) ? noteEl[0] : noteEl)?.value || '';
                            if (!noteValue.trim()) {
                                alert(`第 ${Index + 1} 版本說明為空，請填寫或刪除。`);
                                this.hasEmptyContent = true;
                                return;
                            }
                            const revisionContent = {
                                date: dateValue,
                                note: noteValue
                            };
                            revisionList.push(revisionContent);
                        });
                        const contentList = [];

                        this.modalChapters.forEach((chapter, chapterIndex) => {
                            const chapteRrefKey = `chapterTitle-${chapterIndex}`;
                            const chapterTitleEl = this.$refs[chapteRrefKey];
                            if (!chapterTitleEl) return;  // 沒chapter
                            const chapterTitleValue = (Array.isArray(chapterTitleEl) ? chapterTitleEl[0] : chapterTitleEl)?.value || '';
                            if (!chapterTitleValue.trim()) {
                                alert(`第 ${chapterIndex + 1} 章標題內容為空，請填寫標題或刪除該章。`);
                                this.hasEmptyContent = true;
                                return;
                            }
                            articles = []
                            chapter.articles.forEach((article, aIndex) => {
                                const articleRrefKey = `articleTitle-${chapterIndex}-${aIndex}`;
                                const articleTitleEl = this.$refs[articleRrefKey];
                                if (!articleTitleEl) return;

                                const articleTitleValue = (Array.isArray(articleTitleEl) ? articleTitleEl[0] : articleTitleEl)?.value || '';
                                if (!articleTitleValue.trim()) {
                                    alert(`第 ${article.converted} 條標題為空，請填寫或刪除該條。`);
                                    this.hasEmptyContent = true;
                                    return;
                                }
                                paragraphs = []
                                article.paragraphs.forEach((paragraph, pIndex) => {
                                    const paragraphRrefKey = `paragraphTextarea-${chapterIndex}-${aIndex}-${pIndex}`;
                                    const paragraphContentEl = this.$refs[paragraphRrefKey];
                                    if (!paragraphContentEl) return;

                                    const paragraphContentValue = (Array.isArray(paragraphContentEl) ? paragraphContentEl[0] : paragraphContentEl)?.value || '';
                                    if (!paragraphContentValue.trim()) {
                                        alert(`第 ${article.converted} 條的第 ${pIndex + 1} 項為空，請填寫或刪除該項。`);
                                        this.hasEmptyContent = true;
                                        return;
                                    }
                                    clauses = []
                                    paragraph.clauses.forEach((clause, cIndex) => {
                                        const clauseRrefKey = `clauseTextarea-${chapterIndex}-${aIndex}-${pIndex}-${cIndex}`;
                                        const clauseContentEl = this.$refs[clauseRrefKey];
                                        if (!clauseContentEl) return;

                                        const clauseContentValue = (Array.isArray(clauseContentEl) ? clauseContentEl[0] : clauseContentEl)?.value || '';
                                        if (!clauseContentValue.trim()) {
                                            alert(`第 ${article.converted} 條的第 ${pIndex + 1} 項的第 ${cIndex + 1} 款為空，請填寫或刪除該款。`);
                                            this.hasEmptyContent = true;
                                            return;
                                        }
                                        // 加進去clause
                                        clauses.push({
                                            content: clauseContentValue,
                                            number: clause.number,
                                            // chineseNumber: clause.chineseNumber
                                        });
                                    });
                                    // 加進去paragraph
                                    paragraphs.push({
                                        content: paragraphContentValue,
                                        number: paragraph.number,
                                        clauses: clauses,
                                    });
                                });
                                // 加進去article
                                articles.push({
                                    title: articleTitleValue,
                                    sort_index: article.sort_index,
                                    // converted: article.converted,
                                    paragraphs: paragraphs
                                });
                            });
                            const chapterContent = {
                                title: chapterTitleValue,
                                number: chapter.number,
                                articles: articles
                            };
                            contentList.push(chapterContent);
                        });
                        return [revisionList, contentList];
                    },
                    chineseToNumber(chinese) {
                        const map = { '零': 0, '一': 1, '二': 2, '三': 3, '四': 4, '五': 5, '六': 6, '七': 7, '八': 8, '九': 9 };
                        let result = 0;

                        if (chinese.includes('十')) {
                            const parts = chinese.split('十');

                            const tens = parts[0] === '' ? 1 : map[parts[0]]; // 處理「十」代表「一十」
                            result += tens * 10;

                            if (parts[1]) {
                                result += map[parts[1]];
                            }
                        } else {
                            result += map[chinese];
                        }

                        return result;
                    },
                    numberToChinese(num) {
                        const units = ['', '十', '二十', '三十', '四十', '五十', '六十', '七十', '八十', '九十'];
                        const digits = ['', '一', '二', '三', '四', '五', '六', '七', '八', '九'];

                        if (num <= 0 || num >= 100) return '不支援';

                        const ten = Math.floor(num / 10);
                        const one = num % 10;

                        if (num < 10) {
                            return digits[num];
                        } else if (one === 0) {
                            return units[ten];
                        } else if (ten === 1) {
                            return '十' + digits[one]; // 特別處理 10~19
                        } else {
                            return units[ten] + digits[one];
                        }
                    },
                    createArticle(sortIndex, converted) {
                        return {
                            sort_index: sortIndex,
                            converted: converted,
                            title: '',
                            paragraphs: []
                        };
                    },
                    updateArticlesAfterAdd(chapterIndex, startIdx) {
                        const articles = this.modalChapters[chapterIndex].articles;
                        const newSortIndices = [];
                        for (let i = startIdx; i < articles.length; i++) {
                            articles[i].sort_index += 1;
                            newSortIndices.push(articles[i].sort_index);
                        }
                        if (newSortIndices.length) {
                            const convertedList = this.convertArticles(newSortIndices, 0);
                            for (let i = startIdx; i < articles.length; i++) {
                                articles[i].converted = convertedList[i - startIdx].converted;
                            }
                        }
                    },
                    updateArticlesAfterDelete(chapterIndex, startIdx) {
                        const articles = this.modalChapters[chapterIndex].articles;
                        const newSortIndices = [];
                        for (let i = startIdx; i < articles.length; i++) {
                            articles[i].sort_index -= 1;
                            newSortIndices.push(articles[i].sort_index);
                        }
                        if (newSortIndices.length) {
                            const convertedList = this.convertArticles(newSortIndices, 0);
                            for (let i = startIdx; i < articles.length; i++) {
                                articles[i].converted = convertedList[i - startIdx].converted;
                            }
                        }
                    },
                    convertArticles(floatList, type) {
                        // console.log('floatList', floatList)
                        const chineseNumbers = ["零", "一", "二", "三", "四", "五", "六", "七", "八", "九", "十",
                            "十一", "十二", "十三", "十四", "十五", "十六", "十七", "十八", "十九", "二十"];
                        const suffixMap = ["之一", "之二", "之三", "之四", "之五", "之六", "之七", "之八", "之九", "之十"];

                        const suffixLookup = {};
                        const decimalSeen = {};  // 每條的非整數出現順序
                        const lastLabelMap = {}; // 每條的最後一個 label
                        const convertedList = [];

                        // 第一次先建立每條的最後一個 label
                        floatList.forEach(num => {
                            const intPart = Math.floor(num);
                            const base = chineseNumbers[intPart] + "條";

                            if (!decimalSeen[intPart]) decimalSeen[intPart] = [];

                            let label = "";

                            if (Number.isInteger(num)) {
                                label = base;
                            } else {
                                if (!suffixLookup[num]) {
                                    const index = decimalSeen[intPart].length;
                                    const suffix = suffixMap[index] || `之${index + 1}`;
                                    suffixLookup[num] = suffix;
                                    decimalSeen[intPart].push(num);
                                }
                                label = base + suffixLookup[num];
                            }

                            lastLabelMap[intPart] = label;
                        });

                        // 第二次產生結果 list 並標記最後一個
                        floatList.forEach(num => {
                            const intPart = Math.floor(num);
                            const base = chineseNumbers[intPart] + "條";

                            let label = "";

                            if (Number.isInteger(num)) {
                                label = base;
                            } else {
                                label = base + suffixLookup[num];
                            }

                            convertedList.push({
                                converted: label,
                            });
                        });
                        if (!type) { this.articleLastNumber = Math.max(...Object.keys(lastLabelMap).map(Number)); }

                        return convertedList;
                    },
                    autoResize(event) {
                        const textarea = event.target;
                        textarea.style.height = 'auto';
                        textarea.style.height = textarea.scrollHeight + 'px';
                    },
                    autoResizeAll() {
                        const textareas = this.$el.querySelectorAll('.auto-resize-textarea');
                        textareas.forEach((ta) => {
                            ta.style.height = 'auto';
                            ta.style.height = ta.scrollHeight + 'px';
                        });
                        console.log('d', textareas)
                    },
                    formatDate(date) {
                        let year = date.getUTCFullYear();
                        let month = String(date.getUTCMonth() + 1).padStart(2, '0');
                        let day = String(date.getUTCDate()).padStart(2, '0');
                        return `${year}-${month}-${day}`;
                    }
                },
                mounted() {

                },
            });
        </script>
        {% endraw %}

</body>

</html>