<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>admin_minutes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script> <!-- å¼•å…¥ Axios -->
    <link rel="stylesheet" href="/static/css/admin_minutes.css">

</head>


<body>
    {% raw %}
    <!-- Header -->
    <div class="content-container">
        <header>
            <nav>
                <ul>
                    <li><a href="/admin">æœƒè­°é€šçŸ¥</a></li>
                    <li><a href="/admin/minutes">æœƒè­°è¨˜éŒ„</a></li>
                    <li><a href="/admin/regulations">è¦ç« </a></li>
                    <li><a href="/">ç™»å‡º</a></li>
                </ul>
            </nav>
        </header>
        <div id="app">

            <!-- <input type="file" @change="selectFile">
            <button @click="uploadFile">ä¸Šå‚³</button> -->
            <!-- <a :href="fileUrl" download="filename">é»æ“Šä¸‹è¼‰</a> -->
            <button type="button" class="new_btn" data-bs-toggle="modal" data-bs-target="#exampleModal">æ–°å¢ç´€éŒ„</button>
            <!-- Modal -->
            <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel"
                aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">
                                <div class="form-group">
                                    <label for="record_title" class="input_text">æœƒè­°æ¨™é¡Œ :</label>
                                    <input id="record_title" type="text" class="form-control"
                                        placeholder="ä¾‹ï¼š113-2å­¸ç”Ÿä»£è¡¨å¤§æœƒç¬¬ä¸€æ¬¡å®šæœŸå¤§æœƒè­°ç¨‹æš¨é—œä¿‚æ–‡æ›¸" aria-label="æœƒè­°æ¨™é¡Œ"
                                        aria-describedby="basic-addon1">
                                </div>
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="record_session" class="input_text">å±†æ•¸ :</label>
                                <input id="record_session" type="text" class="form-control" placeholder="ä¾‹ï¼šç¬¬äºŒåå…­å±†"
                                    aria-label="å±†æ•¸" aria-describedby="basic-addon1" v-model="latest_session">
                            </div>
                            <div class="form-group">
                                <label for="record_date" class="input_text">æœƒè­°æ—¥æœŸ :</label>
                                <input id="record_date" type="datetime-local" class="form-control" aria-label="æœƒè­°æ—¥æœŸ"
                                    aria-describedby="basic-addon1">
                            </div>
                            <div class="form-group">
                                <label for="record_place" class="input_text">æœƒè­°åœ°é» :</label>
                                <input id="record_place" type="text" class="form-control" placeholder="æœƒè­°åœ°é»"
                                    aria-label="æœƒè­°åœ°é»" aria-describedby="basic-addon1">
                            </div>
                            <div class="form-group">
                                <label for="contact_person" class="input_text">æœƒè­°è¯çµ¡äºº :</label>
                                <input id="contact_person" type="text" class="form-control" placeholder="æœƒè­°è¯çµ¡äºº"
                                    aria-label="æœƒè­°è¯çµ¡äºº" aria-describedby="basic-addon1">
                            </div>
                            <div class="form-group">
                                <label for="shorthand_link" class="input_text">é€Ÿè¨˜é€£çµ :</label>
                                <input id="shorthand_link" type="text" class="form-control" placeholder="é€Ÿè¨˜é€£çµ"
                                    aria-label="é€Ÿè¨˜é€£çµ" aria-describedby="basic-addon1">
                            </div>
                            <div class="form-group">
                                <label for="present_list" class="input_text">å‡ºå¸­åå–® :</label>
                                <textarea id="present_list" class="form-control" placeholder="ä¾‹ï¼šè­°é•· ç‹oæ˜ã€å‰¯è­°é•· ç‹xæ˜ã€......"
                                    aria-label="å‡ºå¸­åå–®" aria-describedby="basic-addon1"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="attendance_list" class="input_text">åˆ—å¸­åå–® :</label>
                                <textarea id="attendance_list" class="form-control"
                                    placeholder="ä¾‹ï¼šè­°é•· ç‹oæ˜ã€å‰¯è­°é•· ç‹xæ˜ã€......" aria-label="åˆ—å¸­åå–®"
                                    aria-describedby="basic-addon1"></textarea>
                            </div>
                            <div class="input_text">è­°ç¨‹</div>
                            <div v-for="(item, index) in numberedschedule" :key="index">
                                <div class="agenda-item">
                                    <div class="normal_text">{{ item.number }}ã€{{ item.name }}</div>
                                    <button type="button" class="detail_btn" @click="add_detail(index)">æ–°å¢ç´°é …</button>
                                </div>
                                <div :id="'detail' + index">
                                </div>
                                <div v-if="index === beforeDiscussion">
                                    <div class="agenda-item">
                                        <button type="button" class="schedule_btn" @click="add_schedule()">æ–°å¢è­°ç¨‹</button>
                                        <input id="schedule_title" type="text" class="form-control"
                                            placeholder="æ–°å¢ä¹‹è­°ç¨‹æ¨™é¡Œ e.g. äººäº‹åŒæ„æ¡ˆ" aria-label="æ–°å¢ä¹‹è­°ç¨‹æ¨™é¡Œ"
                                            aria-describedby="basic-addon1">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" @click="saveChange()">Save
                                changes</button>
                        </div>
                    </div>
                </div>
            </div>
            <div v-for="(items, key) in scsession" :key="key" class="section">
                <h1>{{ key }}</h1>
                <div v-for="item in items" :key="item.id">
                    <button class="item_btn">{{ item.title }}</button>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer>
            <p>&copy; 2025 Your Company. All rights reserved.</p>
        </footer>
    </div>
    <script>
        new Vue({
            el: '#app',
            data: {
                selectedFile: null,
                fileUrl: "",
                chineseNumbers: ["ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­", "ä¸ƒ", "å…«", "ä¹", "å", "åä¸€", "åäºŒ", "åä¸‰", "åå››", "åäº”", "åå…­", "åä¸ƒ", "åå…«", "åä¹", "äºŒå"],
                schedule: [
                    { name: "å®£å¸ƒé–‹æœƒ", details: [] },
                    { name: "ç¢ºèªè­°ç¨‹", details: [] },
                    { name: "ä¸»å¸­å ±å‘Š", details: [] },
                    { name: "å ±å‘Šäº‹é …", details: [] },
                    { name: "è¨è«–äº‹é …", details: [] },
                    { name: "è‡¨æ™‚å‹•è­°", details: [] },
                    { name: "è‡ªç”±ç™¼è¨€", details: [] },
                    { name: "æ•£æœƒ", details: [] },
                ],
                mergedschedule: [
                    { name: "å®£å¸ƒé–‹æœƒ", details: [] },
                    { name: "ç¢ºèªè­°ç¨‹", details: [] },
                    { name: "ä¸»å¸­å ±å‘Š", details: [] },
                    { name: "å ±å‘Šäº‹é …", details: [] },
                    { name: "è¨è«–äº‹é …", details: [] },
                    { name: "è‡¨æ™‚å‹•è­°", details: [] },
                    { name: "è‡ªç”±ç™¼è¨€", details: [] },
                    { name: "æ•£æœƒ", details: [] },
                ], // åˆä½µæ–°å¢çš„è­°ç¨‹
                addedschedule: [], // å­˜æ”¾æ–°å¢çš„è­°ç¨‹
                details: {}, // å„²å­˜æ¯å€‹è­°ç¨‹çš„ç´°é …
                beforeDiscussion: 3,
                latest_session: "",
                scsession: [],
                record: [],
                message: 'Please log in',
                username: '',
                password: '',
                errorMessage: '',
                modalData: {},      // æ¨¡æ…‹æ¡†é¡¯ç¤ºçš„è³‡æ–™
                // schedule: { "å®£å¸ƒé–‹æœƒ": [], "ç¢ºèªè­°ç¨‹": [], "ä¸»å¸­å ±å‘Š": [], "å ±å‘Šäº‹é …": [], "è¨è«–äº‹é …": [], "è‡¨æ™‚å‹•è­°": [], "è‡ªç”±ç™¼è¨€": [], "æ•£æœƒ": [] },
            },
            async created() {
                // åœ¨ç»„ä»¶åˆ›å»ºæ—¶è·å–åç«¯æ•°æ®
                console.log('Vue instance created.');  // Debug log
                await this.fetchBackendData();

            }, computed: {
                numberedschedule() {
                    let before = this.schedule.findIndex(item => item.name === "è¨è«–äº‹é …");
                    this.beforeDiscussion = before - 1;
                    let merged = [
                        ...this.schedule.slice(0, before),  // ã€Œé–‹æœƒã€å’Œã€Œç¢ºèªè­°ç¨‹ã€
                        ...this.addedschedule,                     // æ–°å¢è­°ç¨‹æ’å…¥é€™è£¡
                        ...this.schedule.slice(before)     // ã€Œä¸»å¸­å ±å‘Šã€èˆ‡ã€Œå ±å‘Šäº‹é …ã€å¾Œç§»
                    ];
                    this.mergedschedule = merged;
                    console.log(this.mergedschedule);
                    return merged.map((item, index) => ({
                        number: this.chineseNumbers[index], // è½‰æ›ç‚ºä¸­æ–‡æ•¸å­—
                        name: item.name
                    }));
                }
            },
            methods: {
                // è·å–åç«¯æ•°æ®çš„æ–¹æ³•
                async fetchBackendData() {
                    try {
                        const response = await axios.get('/admin/data'); // å‡è®¾ä½ çš„åç«¯ API è·¯å¾„æ˜¯ '/api/data'
                        if (response.data) { // Debug log
                            this.scsession = response.data[0]
                            this.latest_session = Object.keys(this.scsession)[0];
                            console.log('Data fetched:', this.scsession, 'latest:', this.latest_session);
                        }
                    } catch (error) {
                        console.error("Error fetching data:", error);
                    }
                },
                closeModal() {
                    var myModal = bootstrap.Modal.getInstance(document.getElementById('exampleModal'));
                    myModal.hide();
                },
                parseString(str) {
                    let result = {};

                    // å¦‚æœæ˜¯ç©ºç™½å­—ä¸²å‰‡å ±éŒ¯
                    if (!str || str.trim() === "") {
                        throw new Error("è¼¸å…¥ä¸èƒ½ç‚ºç©ºç™½");
                    }

                    // å¦‚æœæ˜¯ã€Œå…¨é«”å“¡å·¥ã€æˆ–å…¶ä»–ç„¡ç©ºæ ¼çš„å­—ä¸²ï¼Œç›´æ¥å›å‚³
                    if (/^\S+$/.test(str.trim())) {  // åˆ¤æ–·æ˜¯å¦ç‚ºç„¡ç©ºæ ¼çš„å­—ä¸²
                        return { [str.trim()]: [] };
                    }

                    // ç”¨é “è™Ÿåˆ†éš”
                    let items = str.split("ã€").map(item => item.trim()).filter(item => item !== "");

                    items.forEach(item => {
                        // ä½¿ç”¨æ­£è¦è¡¨é”å¼ç§»é™¤å¤šé‡ç©ºç™½ï¼Œåªä¿ç•™ä¸€å€‹ç©ºæ ¼
                        item = item.replace(/\s+/g, " ");
                        let parts = item.split(" ");

                        // å¦‚æœæ ¼å¼éŒ¯èª¤ï¼ˆåªæœ‰è·ç¨±è€Œæ²’æœ‰å§“åï¼‰ï¼Œè·³éè©²é …
                        if (parts.length < 2) return;

                        let title = parts[0];
                        let name = parts.slice(1).join(" ");

                        if (!result[title]) {
                            result[title] = [];
                        }
                        result[title].push(name);
                    });

                    return result;
                },
                async saveChange() {
                    const formData = new FormData();

                    // åŸºæœ¬æ¬„ä½
                    formData.append("title", document.getElementById("record_title").value);
                    formData.append("session", document.getElementById("record_session").value);
                    formData.append("date", document.getElementById("record_date").value);
                    formData.append("place", document.getElementById("record_place").value);
                    formData.append("person", document.getElementById("contact_person").value);
                    formData.append("shorthand", document.getElementById("shorthand_link").value);
                    formData.append("present", JSON.stringify(this.parseString(document.getElementById("present_list").value)));
                    formData.append("attendance", JSON.stringify(this.parseString(document.getElementById("attendance_list").value)));

                    const content = [];

                    for (let i = 0; i < this.mergedschedule.length; i++) {
                        const schedule = this.mergedschedule[i];
                        const details = [];

                        for (let j = 0; j < schedule.details.length; j++) {
                            const detailId = `detail${i}_${j}`;
                            const contentValue = document.getElementById(detailId).value;
                            this.mergedschedule[i].details[j].content = contentValue;

                            const detail = {
                                content: contentValue,
                                files: []
                            };

                            const fileList = this.mergedschedule[i].details[j].files;
                            for (let k = 0; k < fileList.length; k++) {
                                const file = fileList[k];
                                if (file !== null) {
                                    const fieldName = `file_${i}_${j}_${k}`;
                                    formData.append(fieldName, file);
                                    detail.files.push(fieldName); // å›å‚³æ™‚å¯å°æ‡‰ file_url
                                }
                            }

                            details.push(detail);
                        }

                        content.push({
                            name: schedule.name,
                            details
                        });
                    }

                    // content è¦è½‰æˆ JSON å­—ä¸²é€åˆ°å¾Œç«¯
                    formData.append("content", JSON.stringify(content));

                    try {
                        const response = await axios.post("/newRecord", formData, {
                            headers: {
                                "Content-Type": "multipart/form-data"
                            }
                        });

                        // ğŸ”„ æ›´æ–°å›ä¾†çš„è³‡æ–™
                        if (response.data && response.data.updatedData) {
                            this.scsession = response.data.updatedData;
                            this.latest_session = Object.keys(this.scsession)[0];
                            console.log("å·²æ›´æ–° scsessionï¼š", this.scsession, this.latest_session);
                        }

                        this.closeModal();
                        // window.location.reload();
                    } catch (error) {
                        console.error("ä¸Šå‚³å¤±æ•—ï¼š", error);
                    }
                }
                ,
                // async saveChange() {
                //                     var session = document.getElementById("record_session").value;
                //                     let detailData = {}; // ç”¨äºå­˜å‚¨æ‰€æœ‰è¾“å…¥æ¡†æ•°æ®
                //                     detailData["title"] = document.getElementById("record_title").value;
                //                     detailData["session"] = document.getElementById("record_session").value;
                //                     detailData["date"] = document.getElementById("record_date").value;
                //                     detailData["place"] = document.getElementById("record_place").value;
                //                     detailData["person"] = document.getElementById("contact_person").value;
                //                     detailData["shorthand"] = document.getElementById("shorthand_link").value;
                //                     detailData["present"] = this.parseString(document.getElementById("present_list").value);
                //                     detailData["attendance"] = this.parseString(document.getElementById("attendance_list").value);
                //                     for (i = 0; i < this.mergedschedule.length; i++) {
                //                         console.log(this.mergedschedule[i].name);
                //                         if (this.mergedschedule[i].details.length > 0) {
                //                             for (j = 0; j < this.mergedschedule[i].details.length; j++) {
                //                                 var str = "detail" + i.toString() + "_" + (j).toString();
                //                                 let detailContent = document.getElementById(str).value;
                //                                 this.mergedschedule[i].details[j].content = detailContent;
                //                                 // detailData[this.mergedschedule[i].name] = this.mergedschedule[i].details.map(detail => detail.content);
                //                             }
                //                         }
                //                     }
                //                     detailData["content"] = this.mergedschedule.map(schedule => ({
                //                         name: schedule.name,
                //                         details: schedule.details.map(detail => detail.content)
                //                     }));
                //                     // detailData["file"]
                //                     console.log(detailData["content"]);
                //                     try {
                //                         if (session in this.scsession) {
                //                             const response = axios.post('/newRecord', detailData);
                //                             this.scsession[session].push(detailData);
                //                         } else {
                //                             const response = await axios.post('/newRecord', detailData);
                //                             this.scsession = response.data[0]
                //                             this.latest_session = Object.keys(this.scsession)[0];
                //                         }
                //                         console.log('Data fetched:', this.scsession);
                //                         this.closeModal();
                //                         window.location.reload();
                //                     } catch (error) {
                //                         console.log(error)
                //                     }
                //                 },
                add_detail(index) {
                    console.log(`${index}åœ¨ ${this.chineseNumbers[index]}ã€${this.mergedschedule[index].name}ä¸‹æ–°å¢ç´°é …`);
                    // let number = this.chineseNumbers[index]; // å–å¾—å°æ‡‰çš„ä¸­æ–‡æ•¸å­—
                    // åŠ å…¥ä¸€ç­†æ–°çš„ç´°é …è³‡æ–™çµæ§‹
                    this.mergedschedule[index].details.push({
                        content: "",
                        files: []
                    });
                    const textarea = document.createElement("textarea");
                    textarea.className = "form-control";
                    textarea.placeholder = "è«‹è¼¸å…¥å…§å®¹";
                    const detailIndex = this.mergedschedule[index].details.length - 1;
                    textarea.id = `detail${index}_${detailIndex}`;

                    // å»ºç«‹æª”æ¡ˆå€å¡Šå®¹å™¨ï¼ˆèµ·åˆæ˜¯ç©ºçš„ï¼‰
                    const fileContainer = document.createElement("div");
                    fileContainer.className = "file-container mb-2";
                    fileContainer.id = `fileContainer_${index}_${detailIndex}`;

                    // å»ºç«‹æ–°å¢æª”æ¡ˆæŒ‰éˆ•ï¼ˆç¬¬ä¸€æ¬¡ä¸é™„å¸¶æª”æ¡ˆ inputï¼‰
                    const addFileBtn = document.createElement("button");
                    addFileBtn.textContent = "æ–°å¢æª”æ¡ˆ";
                    addFileBtn.className = "btn btn-secondary btn-sm mt-2";
                    addFileBtn.addEventListener("click", () => {
                        this.createFileInput(index, detailIndex, fileContainer);
                    });

                    // åŒ…èµ·ä¾†æ”¾é€²ç•«é¢
                    const wrapper = document.createElement("div");
                    wrapper.className = "detail-wrapper border p-2 mb-3 rounded";
                    wrapper.appendChild(textarea);
                    wrapper.appendChild(fileContainer);
                    wrapper.appendChild(addFileBtn);

                    const container = document.getElementById(`detail${index}`);
                    container.appendChild(wrapper);

                    // å»ºç«‹ input[type="file"]
                    // const fileInput = document.createElement("input");
                    // fileInput.type = "file";
                    // fileInput.className = "form-control mt-2";
                    // fileInput.addEventListener("change", (event) => {
                    //     this.selectFile(event, index, detailIndex);
                    // });
                    // // å»ºç«‹ä¸Šå‚³æŒ‰éˆ•
                    // const uploadButton = document.createElement("button");
                    // uploadButton.className = "btn btn-primary mt-2";
                    // uploadButton.innerText = "ä¸Šå‚³";
                    // uploadButton.addEventListener("click", () => {
                    //     this.uploadFile(index, detailIndex);
                    // });

                    // // å°‡æ‰€æœ‰å…ƒç´ åŠ åˆ°å°æ‡‰çš„ detail å€å¡Šä¸­
                    // const containerId = `detail${index}`;
                    // const container = document.getElementById(containerId);
                    // container.appendChild(textarea);
                    // container.appendChild(fileInput);
                    // container.appendChild(uploadButton);
                    // var str = "detail" + (index.toString());
                    // document.getElementById(str).appendChild(textarea);



                },
                add_schedule() {
                    var schedule_title = document.getElementById("schedule_title").value;
                    let newscheduleName = schedule_title;
                    this.addedschedule.push({
                        name: newscheduleName,
                        details: []
                    });
                    // console.log("æ–°å¢è­°ç¨‹", newschethis.schedule[index].nameduleName);

                },
                createFileInput(index, detailIndex, fileContainer) {
                    const fileIndex = this.mergedschedule[index].details[detailIndex].files.length;

                    // å»ºç«‹ input[type=file]
                    const fileInput = document.createElement("input");
                    fileInput.type = "file";
                    fileInput.className = "form-control d-inline-block w-auto me-2";
                    fileInput.addEventListener("change", (event) => {
                        this.handleFileChange(event, index, detailIndex, fileIndex);
                    });

                    // å»ºç«‹åˆªé™¤æŒ‰éˆ•
                    const deleteBtn = document.createElement("button");
                    deleteBtn.textContent = "åˆªé™¤";
                    deleteBtn.className = "btn btn-danger btn-sm ms-2";
                    deleteBtn.addEventListener("click", () => {
                        fileContainer.removeChild(fileGroup);
                        this.mergedschedule[index].details[detailIndex].files[fileIndex] = null; // ä¿ç•™ä½ç½®ç‚º null
                    });

                    // åŒ…è£¹ input å’ŒæŒ‰éˆ•çš„å®¹å™¨
                    const fileGroup = document.createElement("div");
                    fileGroup.className = "mb-2";
                    fileGroup.appendChild(fileInput);
                    fileGroup.appendChild(deleteBtn);

                    fileContainer.appendChild(fileGroup);

                    // ç´€éŒ„åˆ° Vue è³‡æ–™
                    this.mergedschedule[index].details[detailIndex].files.push(null);
                },
                handleFileChange(event, index, detailIndex, fileIndex) {
                    const file = event.target.files[0];
                    if (file) {
                        this.mergedschedule[index].details[detailIndex].files[fileIndex] = file;
                        console.log(`æª”æ¡ˆæ›´æ–°ï¼š`, file.name);
                    }
                },
                // selectFile(event, index, detailIndex) {
                //     const file = event.target.files[0];
                //     this.selectedFile = event.target.files[0];
                //     this.mergedschedule[index].details[detailIndex].file = file;
                //     console.log(index, detailIndex)
                // },
                async uploadFile(index, detailIndex) {

                    const file = this.mergedschedule[index].details[detailIndex].file;
                    if (!file) {
                        alert("è«‹å…ˆé¸æ“‡æª”æ¡ˆ");
                        return;
                    }

                    let formData = new FormData();
                    formData.append("file", file);

                    try {
                        let response = await fetch("/upload", { method: "POST", body: formData });
                        let result = await response.json();

                        if (response.ok) {
                            console.log("ä¸Šå‚³æˆåŠŸ", result.file_url);
                            console.log(this.mergedschedule)
                        } else {
                            alert(result.error || "ä¸Šå‚³å¤±æ•—");
                        }
                    } catch (error) {
                        console.error("ä¸Šå‚³éŒ¯èª¤", error);
                        alert("ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
                    }
                }
            },
            mounted() {

            }
        });
    </script>
    {% endraw %}

</body>

</html>